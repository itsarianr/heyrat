# Heyrat (حیران)

یک وب‌اپلیکیشن ساده برای مرور اشعار پارسی، اکنون با امکان ساخت نوشته‌های کاربری؛ در حال حاضر ورود با وارد کردن ایمیل انجام می‌شود (Google OAuth در کد باقی مانده است).

## امکانات

- رندر سمت سرور با Express 5 و EJS
- ورود سریع با وارد کردن ایمیل (بدون تأیید)؛ Google OAuth همچنان در کد حفظ شده است
- پایگاه داده‌ی SQLite برای کاربران، نوشته‌ها، ابیات انتخابی و پسندها
- فید زمانی نوشته‌های کاربران همراه با دکمه‌ی «پسند» مشابه توییتر
- انتخاب ابیات (همان منطق ساخت اسکرین‌شات) برای نوشتن و ثبت نوشته
- ذخیره‌ی علاقه‌مندی‌ها در مرورگر و ژنراتور تصویر از ابیات
- طراحی تماماً راست‌به‌چپ با چند پوسته‌ی رنگی قابل تغییر

## پیش‌نیازها

- Node.js نسخه‌ی 16 یا بالاتر
- npm (به‌صورت پیش‌فرض همراه Node.js)
- (اختیاری) حساب Google Cloud برای وقتی که می‌خواهید ورود با گوگل را دوباره فعال کنید

## راه‌اندازی

1. وابستگی‌ها را نصب کنید:

   ```bash
   npm install
   ```

2. متغیرهای محیطی موردنیاز را تنظیم کنید. ساده‌ترین حالت در توسعه این است که یک فایل `.env` کنار `server.js` بسازید:

   ```
   SESSION_SECRET=choose-a-strong-random-secret
   PORT=5000
   # اگر دامنه‌ی نهایی‌تان با `req.host` متفاوت است، برای تولید sitemap مقدار زیر را ست کنید
   # SITEMAP_BASE_URL=https://example.com
   # مقادیر زیر اختیاری‌اند و فقط در صورت فعال‌سازی مجدد Google OAuth لازم می‌شوند
   # GOOGLE_CLIENT_ID=your-google-client-id.apps.googleusercontent.com
   # GOOGLE_CLIENT_SECRET=your-google-client-secret
   # GOOGLE_CALLBACK_URL=http://localhost:5000/auth/google/callback
   ```

   یا اگر ترجیح می‌دهید مستقیم در ترمینال ست کنید (macOS/Linux):

   ```bash
   export SESSION_SECRET="choose-a-strong-random-secret"
   export PORT=5000
   # در صورت نیاز به تولید sitemap با دامنه‌ی واقعی:
   # export SITEMAP_BASE_URL="https://example.com"
   # برای فعال‌سازی مجدد Google OAuth:
   # export GOOGLE_CLIENT_ID="your-google-client-id.apps.googleusercontent.com"
   # export GOOGLE_CLIENT_SECRET="your-google-client-secret"
   # export GOOGLE_CALLBACK_URL="http://localhost:5000/auth/google/callback"
   ```

   > اگر متغیرهای گوگل را تعیین نکنید، ورود همچنان با ایمیل ساده کار می‌کند. برای فعال‌سازی دوباره Google OAuth همین مقادیر را اضافه کنید.

3. سرور را اجرا کنید:

   ```bash
   npm start
   ```

   برنامه به‌صورت پیش‌فرض روی `http://localhost:5000` در دسترس است (قابل تغییر با متغیر محیطی `PORT`).

4. برای توقف، در ترمینال `Ctrl+C` را بزنید.

### محیط توسعه در مقابل تولید

- **توسعه (محلی):** فایل `.env` فقط روی سیستم خودتان بماند و در گیت رد شود (`.gitignore` از قبل آن را نادیده می‌گیرد). با هر بار اجرای `npm start`، مقدارها به‌طور خودکار بارگذاری می‌شوند.
- **تولید:** معمولاً میزبان‌هایی مثل Render، Vercel یا سرور شخصی اجازه‌ی ثبت متغیرهای محیطی را می‌دهند. همان کلیدها را آنجا تعریف کنید و فایل `.env` را روی سرور نگذارید. اگر نیاز دارید از فایل استفاده کنید، آن را خارج از مخزن نگه دارید و هنگام دپلوی در همان مسیر قرار دهید.

## پایگاه داده

- در اولین اجرا فایل SQLite با مسیر `data/heyrat.sqlite` ساخته می‌شود (در صورت نبود، پوشه‌ی `data/` نیز ایجاد می‌گردد).
- جداول موجود:
  - `users`: شناسه‌ی گوگل، ایمیل و نام نمایشی کاربران
  - `posts`: نوشته‌های کاربران، اطلاعات شاعر/کتاب/بخش و متن نوشته
  - `post_couplets`: ابیات انتخاب شده‌ی هر نوشته
  - `likes`: پسندهای کاربران روی هر نوشته
- برای ریست کامل داده‌های کاربران و نوشته‌ها، کافی است فایل `data/heyrat.sqlite` را حذف کنید.

## ساختار پروژه

```
heyrat/
├── server.js          # تنظیمات مسیرها، فید، API پسنـد و پست
├── auth.js            # پیکربندی Passport و Google OAuth
├── db.js              # راه‌اندازی SQLite و کمک‌های کوئری
├── public/
│   ├── client.js      # منطق فرانت‌اند: انتخاب ابیات، نوشته، پسند، پوسته
│   └── styles.css     # استایل RTL، شیت نوشتن، فید و دکمه‌ها
├── views/
│   ├── index.ejs      # صفحه‌ی اصلی + CTA فید
│   ├── feed.ejs       # فید نوشته‌ها و دکمه‌ی پسند
│   ├── poem.ejs       # صفحه‌ی شعر با انتخاب ابیات و حالت نوشته
│   └── auth/          # صفحات ورود با گوگل و تنظیم نام نمایشی
├── data/
│   └── *.json         # داده‌ی آفلاین اشعار (برای فهرست و نمایش)
├── package.json
└── README.md          # این فایل
```

## افزودن محتوای شعری

ساختار فایل‌های JSON مانند قبل است و فقط برای دیتاست شعرها استفاده می‌شود. نمونه‌ی افزودن کتاب جدید:

```json
{
  "id": "book-id",
  "title": "عنوان کتاب",
  "poet": {
    "id": "hafez",
    "name": "حافظ شیرازی"
  },
  "sections": [
    {
      "id": "section-id",
      "title": "عنوان بخش",
      "poems": [
        {
          "id": "poem-id",
          "title": "عنوان شعر",
          "couplets": [
            ["مصرع اول بیت اول", "مصرع دوم بیت اول"],
            ["مصرع اول بیت دوم", "مصرع دوم بیت دوم"]
          ]
        }
      ]
    }
  ]
}
```

- هر شاعر پوشه‌ی اختصاصی خود را در `data/` دارد.
- هر بخش شامل شناسه‌ی یکتا و آرایه‌ای از ابیات است (آرایه‌ی دو عنصری برای هر بیت).

## نکات ورود با گوگل

- در Google Cloud Console یک OAuth 2.0 Client (Web) بسازید.
- آدرس‌های مجاز:
  - Authorized redirect URI → `http://localhost:5000/auth/google/callback`
  - Authorized JavaScript origin → `http://localhost:5000`
- شناسه و کلید تولید شده را در متغیرهای محیطی بالا قرار دهید.
- بعد از اولین ورود، کاربر باید نام نمایشی (Display Name) انتخاب کند؛ این نام در فید نمایش داده می‌شود و ایمیل مخفی می‌ماند.

## لایسنس

این پروژه برای استفاده‌ی آموزشی و شخصی در دسترس است. در صورت مشارکت، لطفاً Pull Request ثبت کنید.*** End Patch
